name: Deploy to Production

on:
  push:
    branches: [main]
    paths-ignore:
      - 'infra/**'
      - '*.md'
      - 'docs/**'
      - 'openspec/**'

concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  REGION: us-central1
  PROJECT_ID: prefect-sbx-sales-engineering

permissions:
  contents: read
  id-token: write

jobs:
  # ==========================================================================
  # Test before deploying
  # ==========================================================================
  test-backend:
    name: Test Backend
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v4

      - name: Set up Python
        run: uv python install 3.11

      - name: Install dependencies
        run: uv sync --dev

      - name: Run tests
        run: uv run pytest tests/ -v --ignore=tests/e2e --ignore=tests/integration -x

  test-frontend:
    name: Test Frontend
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: frontend
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Run type check
        run: npm run type-check

      - name: Run tests
        run: npm run test:ci

  # ==========================================================================
  # Build and push Docker images
  # ==========================================================================
  build-api:
    name: Build API Image
    runs-on: ubuntu-latest
    needs: [test-backend]
    outputs:
      image: ${{ steps.build.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.api
          push: true
          tags: |
            ${{ vars.ARTIFACT_REGISTRY_URL }}/api:${{ github.sha }}
            ${{ vars.ARTIFACT_REGISTRY_URL }}/api:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image
        run: echo "image=${{ vars.ARTIFACT_REGISTRY_URL }}/api:${{ github.sha }}" >> $GITHUB_OUTPUT

  build-frontend:
    name: Build Frontend Image
    runs-on: ubuntu-latest
    needs: [test-frontend]
    outputs:
      image: ${{ steps.build.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.frontend
          push: true
          tags: |
            ${{ vars.ARTIFACT_REGISTRY_URL }}/frontend:${{ github.sha }}
            ${{ vars.ARTIFACT_REGISTRY_URL }}/frontend:latest
          build-args: |
            NEXT_PUBLIC_API_URL=${{ vars.API_SERVICE_URL }}
            NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${{ secrets.NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image
        run: echo "image=${{ vars.ARTIFACT_REGISTRY_URL }}/frontend:${{ github.sha }}" >> $GITHUB_OUTPUT

  build-dlt:
    name: Build DLT Image
    runs-on: ubuntu-latest
    needs: [test-backend]
    outputs:
      image: ${{ steps.build.outputs.image }}
    steps:
      - uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.dlt
          push: true
          tags: |
            ${{ vars.ARTIFACT_REGISTRY_URL }}/dlt:${{ github.sha }}
            ${{ vars.ARTIFACT_REGISTRY_URL }}/dlt:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Output image
        run: echo "image=${{ vars.ARTIFACT_REGISTRY_URL }}/dlt:${{ github.sha }}" >> $GITHUB_OUTPUT

  # ==========================================================================
  # Deploy to Cloud Run
  # ==========================================================================
  deploy-api:
    name: Deploy API
    runs-on: ubuntu-latest
    needs: [build-api]
    environment: production
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ vars.API_SERVICE_NAME }} \
            --image=${{ vars.ARTIFACT_REGISTRY_URL }}/api:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --quiet

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ vars.API_SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "Deployed to: $SERVICE_URL"
          # Wait for service to be ready
          sleep 10
          curl -f "$SERVICE_URL/health" || exit 1

  deploy-frontend:
    name: Deploy Frontend
    runs-on: ubuntu-latest
    needs: [build-frontend, deploy-api]
    environment: production
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Deploy to Cloud Run
        run: |
          gcloud run deploy ${{ vars.FRONTEND_SERVICE_NAME }} \
            --image=${{ vars.ARTIFACT_REGISTRY_URL }}/frontend:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --quiet

      - name: Verify deployment
        run: |
          SERVICE_URL=$(gcloud run services describe ${{ vars.FRONTEND_SERVICE_NAME }} \
            --region=${{ env.REGION }} \
            --format='value(status.url)')
          echo "Deployed to: $SERVICE_URL"
          sleep 10
          curl -f "$SERVICE_URL/api/health" || exit 1

  deploy-dlt:
    name: Update DLT Job
    runs-on: ubuntu-latest
    needs: [build-dlt]
    environment: production
    steps:
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ vars.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ vars.GCP_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Update Cloud Run Job
        run: |
          gcloud run jobs update ${{ vars.DLT_JOB_NAME }} \
            --image=${{ vars.ARTIFACT_REGISTRY_URL }}/dlt:${{ github.sha }} \
            --region=${{ env.REGION }} \
            --quiet

  # ==========================================================================
  # Post-deployment
  # ==========================================================================
  notify:
    name: Notify
    runs-on: ubuntu-latest
    needs: [deploy-api, deploy-frontend, deploy-dlt]
    if: always()
    steps:
      - name: Deployment Summary
        run: |
          echo "## Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Service | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|---------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| API | ${{ needs.deploy-api.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Frontend | ${{ needs.deploy-frontend.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| DLT Job | ${{ needs.deploy-dlt.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
