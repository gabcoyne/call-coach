name: Test Suite

on:
  push:
    branches: [main, develop]
    paths:
      - '**.py'
      - '**.ts'
      - '**.tsx'
      - 'pyproject.toml'
      - 'frontend/package.json'
      - '.github/workflows/tests.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - '**.py'
      - '**.ts'
      - '**.tsx'
      - 'pyproject.toml'
      - 'frontend/package.json'

jobs:
  lint:
    name: Lint & Format
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install ruff black

      - name: Lint with ruff
        run: |
          ruff check . --format=github

      - name: Format check with black
        run: |
          black --check .

  type-check:
    name: Type Check
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"
          pip install mypy

      - name: Type check with mypy
        run: |
          mypy analysis coaching_mcp api --ignore-missing-imports --show-error-codes

  python-tests:
    name: Unit & Integration Tests - Python ${{ matrix.python-version }}
    runs-on: ubuntu-latest
    timeout-minutes: 30

    strategy:
      matrix:
        python-version: ['3.11', '3.12']

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Run unit tests
        run: |
          pytest tests/ -v --cov=analysis --cov=coaching_mcp --cov=api \
            --cov-report=xml --cov-report=term-missing -m "not integration and not slow"

      - name: Check coverage threshold (70%)
        run: |
          python -m pytest tests/ --cov=analysis --cov=coaching_mcp --cov=api \
            --cov-report=term --cov-fail-under=70 -m "not integration and not slow"

      - name: Run integration tests
        run: |
          pytest tests/ -v -m integration

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./coverage.xml
          flags: python
          name: python-${{ matrix.python-version }}
          fail_ci_if_error: true

  frontend-tests:
    name: Frontend Tests
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install dependencies
        working-directory: frontend
        run: npm ci

      - name: Run linting
        working-directory: frontend
        run: npm run lint

      - name: Run tests
        working-directory: frontend
        run: npm test -- --coverage --passWithNoTests

      - name: Build
        working-directory: frontend
        run: npm run build

      - name: Upload coverage
        uses: codecov/codecov-action@v3
        with:
          flags: frontend
          name: frontend
          fail_ci_if_error: false

  e2e-tests:
    name: E2E Tests
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: 'frontend/package-lock.json'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Install Playwright
        run: |
          playwright install

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Start API server
        run: |
          uvicorn api.rest_server:app --host 0.0.0.0 --port 8000 &
          sleep 5

      - name: Build frontend
        working-directory: frontend
        run: npm run build

      - name: Start frontend
        working-directory: frontend
        run: |
          npm start &
          sleep 10

      - name: Run E2E tests
        env:
          BASE_URL: http://localhost:3000
          TEST_USER_EMAIL: ${{ secrets.TEST_USER_EMAIL || 'test@example.com' }}
          TEST_USER_PASSWORD: ${{ secrets.TEST_USER_PASSWORD || 'test-password' }}
          TEST_CALL_ID: ${{ secrets.TEST_CALL_ID || '1234567890' }}
          TEST_REP_EMAIL: ${{ secrets.TEST_REP_EMAIL || 'sarah@example.com' }}
        run: |
          pytest e2e/ -v -m e2e || true

  coverage-report:
    name: Coverage Report
    runs-on: ubuntu-latest
    needs: [python-tests]
    if: always()

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Generate coverage report
        run: |
          pytest tests/ --cov=analysis --cov=coaching_mcp --cov=api \
            --cov-report=html --cov-report=term-missing || true

      - name: Upload HTML coverage report
        uses: actions/upload-artifact@v3
        with:
          name: coverage-report
          path: htmlcov/
